<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>applauncherd: Using the QML booster</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="main.html">Optimising application startup</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Using the QML booster </h1>  </div>
</div>
<div class="contents">
<p>This section describes how to use the QML (QDeclarative) booster. The booster provides the application with the key libraries already present in the process, and instances of <code>QApplication</code> and <code>QDeclarativeView</code> waiting in the cache.</p>
<p>Note: This functionality is currently included in the Qt Quick application template provided by the Qt SDK. To enable QML booster in your application, select Make application boostable checkbox when creating a new project with the template.</p>
<h2><a class="anchor" id="qmlboostprereq"></a>
Prerequisites</h2>
<p>The launcher can start an application if the following prerequisites are met:</p>
<ul>
<li>The QML application uses a C++-based runner.</li>
<li>The runner uses <code>QApplication</code> and <code>QDeclarativeView</code> directly, that is, does not inherit from the classes.</li>
<li><code>applauncherd-dev</code> package is installed.</li>
</ul>
<h2><a class="anchor" id="qmlboostcompiling"></a>
1. Compiling and linking for launcher</h2>
<p>If you intend to run a binary with <code>applauncherd</code>, compile it with <code>-fPIC</code> option to produce position-independent code. It is recommended that you link them either as shared libraries, or, preferably, as position-independent executables, which can be executed both traditionally and with the launcher. The <code>-pie</code> and <code>-rdynamic</code> linker flags accomplish this.</p>
<p>To improve linking and loading times of shared object libraries, it is recommended that you hide any unnecessary symbols from the resulting binary by using <code>-fvisibility=hidden</code> and <code>-fvisibility-inlines-hidden</code> flags as well. However, <code>applauncherd</code> needs to find the entry point for your application, so the symbol <code>main</code> needs to be explicitly made visible. This can be done as follows:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">  #include &lt;QtCore/QtGlobal&gt;</span>
  
  Q_DECL_EXPORT <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
  {
  ...
  }
</pre></div><p>If your application loads a plug-in that needs to access some symbols in the main application, the symbols also need to be exported. In addition, you must use the <code>--global-syms</code> invoker parameter, as described in <a class="el" href="invokerparameters.html">Advanced invoker command line parameters</a>.</p>
<p>Normally you do not need to worry about the compiler and linker flags, as the <code>applauncherd-dev</code> package provides configuration options for <code>qmake</code>, <code>CMake</code>, and <code>pkg-config</code>. If you are building a Debian package, make your package build-depend on <code>applauncherd-dev</code> and your application binary package depend on <code>applauncherd</code>.</p>
<p>For details on how to get the compiler and linker flags, see <a class="el" href="usingqmake.html">Using qmake</a>, <a class="el" href="usingcmake.html">Using CMake</a>, or <a class="el" href="usingpkgconfig.html">Using pkg-config</a>.</p>
<h2><a class="anchor" id="qmlboostcache"></a>
2. Utilising the booster cache</h2>
<p>Instantiating <code>QApplication</code> and <code>QDeclarativeView</code> is a relatively expensive operation. The QML booster helps reduce application startup latency by creating instances of the classes in <a class="el" href="classMDeclarativeCache.html" title="Cache class for QDeclarativeBooster.">MDeclarativeCache</a>. In order to make use of this functionality, the applications need to pick up the instances from the cache. Thus, if the application code instantiates the classes as follows:</p>
<div class="fragment"><pre class="fragment">      QApplication app(argc, argv);
      QDeclarativeView view;
</pre></div><p>Modify it as follows:</p>
<div class="fragment"><pre class="fragment">     QApplication *app = <a class="code" href="classMDeclarativeCache.html#ab46601ff7a2f071a98e02d95ece551c5" title="Returns QApplication instance from cache or creates a new one.">MDeclarativeCache::qApplication</a>(argc, argv);
     QDeclarativeView *window = <a class="code" href="classMDeclarativeCache.html#a937199a0f4c808ea520f785e16c456ce" title="Returns QDeclarativeView instance from cache or creates a new one.">MDeclarativeCache::qDeclarativeView</a>();
</pre></div><p>You also need to add: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">    #include &lt;MDeclarativeCache&gt;</span>
</pre></div><p>The cache class works both with the booster and without it. In the non-boosted case there are no pre-created instances, so the cache class simply creates the instances on the fly.</p>
<p>The ownership of the instances is transferred from the cache to the application code. The instances need to be deleted in the correct order, deleting the <code>QApplication</code> instance before the <code>QDeclarativeView</code> instance is known to cause crashes.</p>
<h2><a class="anchor" id="qmlboostexit"></a>
3. Adapting application source code</h2>
<p>Making use of the cache is typically the only modification needed to the application. However, if the application has explicit calls to <code>exit()</code>, these should be changed to use <code>_exit()</code> instead. The brief explanation is that this prevents cleanup actions related to shared libraries to be performed multiple times. For more details see <a class="el" href="limitations.html">Limitations and known issues</a>.</p>
<h2><a class="anchor" id="qmlboostinvoker"></a>
4. Launching the application</h2>
<p>Now everything should be in place for launching the application. The linker flags create a Position Independent Binary (PIE), so the application can still be invoked from the command line. In order to verify that the modifications done to the application and the build scripts have not broken anything, it is a good idea at this point to check that the application still starts and functions normally from the command line:</p>
<div class="fragment"><pre class="fragment">$ ./myApp
</pre></div><p>The next step is to use the <code>invoker</code> to launch the application. In order for this to work, you need to have <code>applauncherd</code> and <code>booster-d</code> (the QML booster process) running. To check that this is the case, you can do:</p>
<div class="fragment"><pre class="fragment">$ ps ax | grep booster-d
</pre></div><p>If you do not see the booster process, you need to start <code>applauncherd</code> manually. In MeeGo 1.2 Harmattan, <code>applauncherd</code> should be running as part of the UI session.</p>
<p>Once you have verified that the booster process is running, you can use the following command line to ask the booster process to turn into your application:</p>
<div class="fragment"><pre class="fragment">/usr/bin/invoker --type=d ./myApp
</pre></div><p>Your application should start exactly as if it had been invoked from the command line, just a little bit faster. You can now proceed to change the <code></code>.desktop file or <code></code>.service file that launches the application to use the invoker command.</p>
<h2><a class="anchor" id="qmlboostfinishingtouch"></a>
5. Finishing touches</h2>
<p>The invoker can also provide single instance behaviour and a splash screen for your application as follows. For more details, see <a class="el" href="singleinstance.html">Enabling single instance support for an application</a> and <a class="el" href="splash.html">Enabling a splash screen for an application</a>.</p>
<div class="fragment"><pre class="fragment">/usr/bin/invoker --single-instance --splash=/usr/share/myApp/splash.jpg --type=d /usr/bin/myApp
</pre></div> </div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Mar 31 2013 20:49:11 for applauncherd by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
