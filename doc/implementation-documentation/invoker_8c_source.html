<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>applauncherd: /home/tomek/powerpack/mapplauncherd/applauncherd-3.0.3+0m8/src/invoker/invoker.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>/home/tomek/powerpack/mapplauncherd/applauncherd-3.0.3+0m8/src/invoker/invoker.c</h1>  </div>
</div>
<div class="contents">
<a href="invoker_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">**</span>
<a name="l00003"></a>00003 <span class="comment">** Copyright (C) 2010 Nokia Corporation and/or its subsidiary(-ies).</span>
<a name="l00004"></a>00004 <span class="comment">** All rights reserved.</span>
<a name="l00005"></a>00005 <span class="comment">** Contact: Nokia Corporation (directui@nokia.com)</span>
<a name="l00006"></a>00006 <span class="comment">**</span>
<a name="l00007"></a>00007 <span class="comment">** This file is part of applauncherd</span>
<a name="l00008"></a>00008 <span class="comment">**</span>
<a name="l00009"></a>00009 <span class="comment">** If you have questions regarding the use of this file, please contact</span>
<a name="l00010"></a>00010 <span class="comment">** Nokia at directui@nokia.com.</span>
<a name="l00011"></a>00011 <span class="comment">**</span>
<a name="l00012"></a>00012 <span class="comment">** This library is free software; you can redistribute it and/or</span>
<a name="l00013"></a>00013 <span class="comment">** modify it under the terms of the GNU Lesser General Public</span>
<a name="l00014"></a>00014 <span class="comment">** License version 2.1 as published by the Free Software Foundation</span>
<a name="l00015"></a>00015 <span class="comment">** and appearing in the file LICENSE.LGPL included in the packaging</span>
<a name="l00016"></a>00016 <span class="comment">** of this file.</span>
<a name="l00017"></a>00017 <span class="comment">**</span>
<a name="l00018"></a>00018 <span class="comment">****************************************************************************/</span>
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="invoker_8c.html#a369266c24eacffb87046522897a570d5">00020</a> <span class="preprocessor">#define _GNU_SOURCE</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;stdbool.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;bits/socket.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;sys/un.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;sys/uio.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;report.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;protocol.h&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="invokelib_8h.html">invokelib.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="search_8h.html">search.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#ifdef HAVE_CREDS</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">    #include &lt;sys/creds.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="comment">// Delay before exit.</span>
<a name="l00052"></a><a class="code" href="invoker_8c.html#a9e7b9832d61aae7a2c1345064116296b">00052</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a9e7b9832d61aae7a2c1345064116296b">EXIT_DELAY</a>     = 0;
<a name="l00053"></a><a class="code" href="invoker_8c.html#a5ed2b2b88f84b3b2d8271a1b8b9408ce">00053</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a5ed2b2b88f84b3b2d8271a1b8b9408ce">MIN_EXIT_DELAY</a> = 1;
<a name="l00054"></a><a class="code" href="invoker_8c.html#a998f7d8bd1b495cbe14c695157419b22">00054</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a998f7d8bd1b495cbe14c695157419b22">MAX_EXIT_DELAY</a> = 86400;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">// Delay before a new booster is started. This will</span>
<a name="l00057"></a>00057 <span class="comment">// be sent to the launcher daemon.</span>
<a name="l00058"></a><a class="code" href="invoker_8c.html#a50cc5943369c2b7f9b2175ca58ce6ec5">00058</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a50cc5943369c2b7f9b2175ca58ce6ec5">RESPAWN_DELAY</a>     = 3;
<a name="l00059"></a><a class="code" href="invoker_8c.html#aeb3a737958b9a0ae5d7b90def707bec2">00059</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#aeb3a737958b9a0ae5d7b90def707bec2">MIN_RESPAWN_DELAY</a> = 0;
<a name="l00060"></a><a class="code" href="invoker_8c.html#a94a1c34b76008f80bed1ad20853a11a6">00060</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a94a1c34b76008f80bed1ad20853a11a6">MAX_RESPAWN_DELAY</a> = 10;
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="invoker_8c.html#a59665bcc1165f28a45b5676e7275e78f">00062</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="invoker_8c.html#a59665bcc1165f28a45b5676e7275e78f">EXIT_STATUS_APPLICATION_CONNECTION_LOST</a> = 0xfa;
<a name="l00063"></a><a class="code" href="invoker_8c.html#afb265efdef0a25752de2a080d56f4fa8">00063</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="invoker_8c.html#afb265efdef0a25752de2a080d56f4fa8">EXIT_STATUS_APPLICATION_NOT_FOUND</a> = 0x7f;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">// Enumeration of possible application types:</span>
<a name="l00066"></a>00066 <span class="comment">// M_APP     : MeeGo Touch application</span>
<a name="l00067"></a>00067 <span class="comment">// QT_APP    : Qt/generic application</span>
<a name="l00068"></a>00068 <span class="comment">// QDECL_APP : QDeclarative (QML) application</span>
<a name="l00069"></a>00069 <span class="comment">// EXEC_APP  : Executable generic application (can be used with splash screen)</span>
<a name="l00070"></a>00070 <span class="comment">//</span>
<a name="l00071"></a><a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160aa33303291086103c32a6fe8f170c953f">00071</a> <span class="keyword">enum</span> <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160">APP_TYPE</a> { M_APP, QT_APP, QDECL_APP, EXEC_APP, <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160aa33303291086103c32a6fe8f170c953f">UNKNOWN_APP</a> };
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">// Environment</span>
<a name="l00074"></a>00074 <span class="keyword">extern</span> <span class="keywordtype">char</span> ** <a class="code" href="invoker_8c.html#aa006daaf11f1e2e45a6ababaf463212b">environ</a>;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">// pid of the invoked process</span>
<a name="l00077"></a><a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">00077</a> <span class="keyword">static</span> pid_t <a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a> = -1;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#af38ccce065ad2dd315f08a9af1bdb2b4">sigs_restore</a>(<span class="keywordtype">void</span>);
<a name="l00080"></a>00080 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a619bc4e34f22792efa8a46db6b2084b0">sigs_init</a>(<span class="keywordtype">void</span>);
<a name="l00081"></a>00081 
<a name="l00083"></a><a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100">00083</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>[2];
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">// Forwards Unix signals from invoker to the invoked process</span>
<a name="l00086"></a><a class="code" href="invoker_8c.html#abb550340170a56ae8e77cd48f5fcfdcd">00086</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#abb550340170a56ae8e77cd48f5fcfdcd">sig_forwarder</a>(<span class="keywordtype">int</span> sig)
<a name="l00087"></a>00087 {
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (<a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a> &gt;= 0)
<a name="l00089"></a>00089     {
<a name="l00090"></a>00090         <span class="keywordflow">if</span> (kill(<a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a>, sig) != 0)
<a name="l00091"></a>00091         {
<a name="l00092"></a>00092             <span class="keywordflow">if</span> (sig == SIGTERM &amp;&amp; errno == ESRCH)
<a name="l00093"></a>00093             {
<a name="l00094"></a>00094                 report(report_info,
<a name="l00095"></a>00095                        <span class="stringliteral">&quot;Can&#39;t send signal SIGTERM to application [%i] &quot;</span>
<a name="l00096"></a>00096                        <span class="stringliteral">&quot;because application is already terminated. \n&quot;</span>,
<a name="l00097"></a>00097                        <a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a>);
<a name="l00098"></a>00098             }
<a name="l00099"></a>00099             <span class="keywordflow">else</span>
<a name="l00100"></a>00100             {
<a name="l00101"></a>00101                 report(report_error,
<a name="l00102"></a>00102                       <span class="stringliteral">&quot;Can&#39;t send signal %i to application [%i]: %s \n&quot;</span>,
<a name="l00103"></a>00103                       sig, <a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a>, strerror(errno));
<a name="l00104"></a>00104             }
<a name="l00105"></a>00105         }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         <span class="comment">// Restore signal handlers</span>
<a name="l00108"></a>00108         <a class="code" href="invoker_8c.html#af38ccce065ad2dd315f08a9af1bdb2b4">sigs_restore</a>();
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="comment">// Write signal number to the self-pipe</span>
<a name="l00111"></a>00111         <span class="keywordtype">char</span> signal_id = (char) sig;
<a name="l00112"></a>00112         write(<a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>[1], &amp;signal_id, 1);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114         <span class="comment">// Send the signal to itself using the default handler</span>
<a name="l00115"></a>00115         <span class="keyword">raise</span>(sig);
<a name="l00116"></a>00116 <span class="preprocessor">#ifdef WITH_COVERAGE</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>        __gcov_flush();
<a name="l00118"></a>00118 <span class="preprocessor">#endif</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>    }
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">// Sets signal actions for Unix signals</span>
<a name="l00123"></a><a class="code" href="invoker_8c.html#a555d19127f9cccfd2b9bff3307cbb996">00123</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a555d19127f9cccfd2b9bff3307cbb996">sigs_set</a>(<span class="keyword">struct</span> sigaction *sig)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125     sigaction(SIGABRT,   sig, NULL);
<a name="l00126"></a>00126     sigaction(SIGALRM,   sig, NULL);
<a name="l00127"></a>00127     sigaction(SIGBUS,    sig, NULL);
<a name="l00128"></a>00128     sigaction(SIGCHLD,   sig, NULL);
<a name="l00129"></a>00129     sigaction(SIGCONT,   sig, NULL);
<a name="l00130"></a>00130     sigaction(SIGHUP,    sig, NULL);
<a name="l00131"></a>00131     sigaction(SIGINT,    sig, NULL);
<a name="l00132"></a>00132     sigaction(SIGIO,     sig, NULL);
<a name="l00133"></a>00133     sigaction(SIGIOT,    sig, NULL);
<a name="l00134"></a>00134     sigaction(SIGPIPE,   sig, NULL);
<a name="l00135"></a>00135     sigaction(SIGPROF,   sig, NULL);
<a name="l00136"></a>00136     sigaction(SIGPWR,    sig, NULL);
<a name="l00137"></a>00137     sigaction(SIGQUIT,   sig, NULL);
<a name="l00138"></a>00138     sigaction(SIGSEGV,   sig, NULL);
<a name="l00139"></a>00139     sigaction(SIGSYS,    sig, NULL);
<a name="l00140"></a>00140     sigaction(SIGTERM,   sig, NULL);
<a name="l00141"></a>00141     sigaction(SIGTRAP,   sig, NULL);
<a name="l00142"></a>00142     sigaction(SIGTSTP,   sig, NULL);
<a name="l00143"></a>00143     sigaction(SIGTTIN,   sig, NULL);
<a name="l00144"></a>00144     sigaction(SIGTTOU,   sig, NULL);
<a name="l00145"></a>00145     sigaction(SIGUSR1,   sig, NULL);
<a name="l00146"></a>00146     sigaction(SIGUSR2,   sig, NULL);
<a name="l00147"></a>00147     sigaction(SIGVTALRM, sig, NULL);
<a name="l00148"></a>00148     sigaction(SIGWINCH,  sig, NULL);
<a name="l00149"></a>00149     sigaction(SIGXCPU,   sig, NULL);
<a name="l00150"></a>00150     sigaction(SIGXFSZ,   sig, NULL);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="comment">// Sets up the signal forwarder</span>
<a name="l00154"></a><a class="code" href="invoker_8c.html#a619bc4e34f22792efa8a46db6b2084b0">00154</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a619bc4e34f22792efa8a46db6b2084b0">sigs_init</a>(<span class="keywordtype">void</span>)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     <span class="keyword">struct </span>sigaction sig;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     memset(&amp;sig, 0, <span class="keyword">sizeof</span>(sig));
<a name="l00159"></a>00159     sig.sa_flags = SA_RESTART;
<a name="l00160"></a>00160     sig.sa_handler = sig_forwarder;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <a class="code" href="invoker_8c.html#a555d19127f9cccfd2b9bff3307cbb996">sigs_set</a>(&amp;sig);
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="comment">// Sets up the default signal handler</span>
<a name="l00166"></a><a class="code" href="invoker_8c.html#af38ccce065ad2dd315f08a9af1bdb2b4">00166</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#af38ccce065ad2dd315f08a9af1bdb2b4">sigs_restore</a>(<span class="keywordtype">void</span>)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     <span class="keyword">struct </span>sigaction sig;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     memset(&amp;sig, 0, <span class="keyword">sizeof</span>(sig));
<a name="l00171"></a>00171     sig.sa_flags = SA_RESTART;
<a name="l00172"></a>00172     sig.sa_handler = SIG_DFL;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <a class="code" href="invoker_8c.html#a555d19127f9cccfd2b9bff3307cbb996">sigs_set</a>(&amp;sig);
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">// Shows a list of credentials that the client has</span>
<a name="l00178"></a><a class="code" href="invoker_8c.html#a6ac061f008827b81a8dfe0f99c284fa7">00178</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a6ac061f008827b81a8dfe0f99c284fa7">show_credentials</a>(<span class="keywordtype">void</span>)
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180 <span class="preprocessor">#ifdef HAVE_CREDS</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>    creds_t creds;
<a name="l00182"></a>00182     creds_value_t value;
<a name="l00183"></a>00183     creds_type_t type;
<a name="l00184"></a>00184     <span class="keywordtype">int</span> i;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     creds = creds_gettask(0);
<a name="l00187"></a>00187     <span class="keywordflow">for</span> (i = 0; (type = creds_list(creds, i,  &amp;value)) != CREDS_BAD; ++i) {
<a name="l00188"></a>00188         <span class="keywordtype">char</span> buf[200];
<a name="l00189"></a>00189         (void)creds_creds2str(type, value, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00190"></a>00190         buf[<span class="keyword">sizeof</span>(buf)-1] = 0;
<a name="l00191"></a>00191         printf(<span class="stringliteral">&quot;\t%s\n&quot;</span>, buf);
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193     creds_free(creds);
<a name="l00194"></a>00194 <span class="preprocessor">#else</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;Security credential information isn&#39;t available.\n&quot;</span>);
<a name="l00196"></a>00196 <span class="preprocessor">#endif</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>
<a name="l00198"></a>00198     exit(0);
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="comment">// Receive ACK</span>
<a name="l00202"></a><a class="code" href="invoker_8c.html#af3be588b0f5f31deba1f8a83671be134">00202</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="invoker_8c.html#af3be588b0f5f31deba1f8a83671be134">invoke_recv_ack</a>(<span class="keywordtype">int</span> fd)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204     uint32_t action;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <a class="code" href="invokelib_8c.html#a5bd16489ce19f6d961089212dc520c40">invoke_recv_msg</a>(fd, &amp;action);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordflow">if</span> (action == INVOKER_MSG_BAD_CREDS)
<a name="l00209"></a>00209     {
<a name="l00210"></a>00210         die(1, <span class="stringliteral">&quot;Security credential check failed.\n&quot;</span>);
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action != INVOKER_MSG_ACK)
<a name="l00213"></a>00213     {
<a name="l00214"></a>00214         die(1, <span class="stringliteral">&quot;Received wrong ack (%08x)\n&quot;</span>, action);
<a name="l00215"></a>00215     }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="comment">// Inits a socket connection for the given application type</span>
<a name="l00221"></a><a class="code" href="invoker_8c.html#aef14fae16666ae75d89dcaf6fa741ea3">00221</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#aef14fae16666ae75d89dcaf6fa741ea3">invoker_init</a>(<span class="keyword">enum</span> <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160">APP_TYPE</a> app_type)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223     <span class="keywordtype">int</span> fd;
<a name="l00224"></a>00224     <span class="keyword">struct </span>sockaddr_un sun;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     fd = socket(PF_UNIX, SOCK_STREAM, 0);
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (fd &lt; 0)
<a name="l00228"></a>00228     {
<a name="l00229"></a>00229         error(<span class="stringliteral">&quot;Failed to open invoker socket.\n&quot;</span>);
<a name="l00230"></a>00230         <span class="keywordflow">return</span> -1;
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     sun.sun_family = AF_UNIX;  <span class="comment">//AF_FILE;</span>
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="keyword">const</span> <span class="keywordtype">int</span> maxSize = <span class="keyword">sizeof</span>(sun.sun_path) - 1;
<a name="l00236"></a>00236     <span class="keywordflow">if</span>(app_type == <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160aedd7954fb75ba9170bdc9ad2896a82c7">M_APP</a>)
<a name="l00237"></a>00237     {
<a name="l00238"></a>00238         strncpy(sun.sun_path, <a class="code" href="invokelib_8h.html#aa343907e2da21e0e9c2e3224aefd43a6">INVOKER_M_SOCK</a>, maxSize);
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_type == <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160abe24a6ebdbce172f642f28c23d4e9aa6">QT_APP</a>)
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242         strncpy(sun.sun_path, <a class="code" href="invokelib_8h.html#a0e249a8cef40894e359c24befd0bc7cc">INVOKER_QT_SOCK</a>, maxSize);
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_type == <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160a1dac251c9da0be6bc43bbe78514e69f5">QDECL_APP</a>)
<a name="l00245"></a>00245     {
<a name="l00246"></a>00246       strncpy(sun.sun_path, <a class="code" href="invokelib_8h.html#ad7f7fbcb8d4afc2b8261368faf7d86ba">INVOKER_QDECL_SOCK</a>, maxSize);
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_type == <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160a59e0746009b7ba1166cdd4e4405f4f64">EXEC_APP</a>)
<a name="l00249"></a>00249     {
<a name="l00250"></a>00250       strncpy(sun.sun_path, <a class="code" href="invokelib_8h.html#a06302015f10320b82d4110cf9bf2b412">INVOKER_EXEC_SOCK</a>, maxSize);
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252     <span class="keywordflow">else</span>
<a name="l00253"></a>00253     {
<a name="l00254"></a>00254         die(1, <span class="stringliteral">&quot;Unknown type of application: %d\n&quot;</span>, app_type);
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     sun.sun_path[maxSize] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (connect(fd, (<span class="keyword">struct</span> sockaddr *)&amp;sun, <span class="keyword">sizeof</span>(sun)) &lt; 0)
<a name="l00260"></a>00260     {
<a name="l00261"></a>00261         error(<span class="stringliteral">&quot;Failed to initiate connect on the socket.\n&quot;</span>);
<a name="l00262"></a>00262         <span class="keywordflow">return</span> -1;
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <span class="keywordflow">return</span> fd;
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="comment">// Receives pid of the invoked process.</span>
<a name="l00269"></a>00269 <span class="comment">// Invoker doesn&#39;t know it, because the launcher daemon</span>
<a name="l00270"></a>00270 <span class="comment">// is the one who forks.</span>
<a name="l00271"></a><a class="code" href="invoker_8c.html#adda5347bd0fada2e1aa680cdf215d295">00271</a> <span class="keyword">static</span> uint32_t <a class="code" href="invoker_8c.html#adda5347bd0fada2e1aa680cdf215d295">invoker_recv_pid</a>(<span class="keywordtype">int</span> fd)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273     <span class="comment">// Receive action.</span>
<a name="l00274"></a>00274     uint32_t action;
<a name="l00275"></a>00275     <a class="code" href="invokelib_8c.html#a5bd16489ce19f6d961089212dc520c40">invoke_recv_msg</a>(fd, &amp;action);
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (action != INVOKER_MSG_PID)
<a name="l00277"></a>00277         die(1, <span class="stringliteral">&quot;Received a bad message id (%08x)\n&quot;</span>, action);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="comment">// Receive pid.</span>
<a name="l00280"></a>00280     uint32_t pid = 0;
<a name="l00281"></a>00281     <a class="code" href="invokelib_8c.html#a5bd16489ce19f6d961089212dc520c40">invoke_recv_msg</a>(fd, &amp;pid);
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (pid == 0)
<a name="l00283"></a>00283         die(1, <span class="stringliteral">&quot;Received a zero pid \n&quot;</span>);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="keywordflow">return</span> pid;
<a name="l00286"></a>00286 }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 <span class="comment">// Receives exit status of the invoked process</span>
<a name="l00289"></a><a class="code" href="invoker_8c.html#adb904f45873b687b7eae3e04758ba933">00289</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="invoker_8c.html#adb904f45873b687b7eae3e04758ba933">invoker_recv_exit</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span>* status)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     uint32_t action;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="comment">// Receive action.</span>
<a name="l00294"></a>00294     <span class="keywordtype">bool</span> res = <a class="code" href="invokelib_8c.html#a5bd16489ce19f6d961089212dc520c40">invoke_recv_msg</a>(fd, &amp;action);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (!res || (action != INVOKER_MSG_EXIT))
<a name="l00297"></a>00297     {
<a name="l00298"></a>00298         <span class="comment">// Boosted application process was killed somehow.</span>
<a name="l00299"></a>00299         <span class="comment">// Let&#39;s give applauncherd process some time to cope </span>
<a name="l00300"></a>00300         <span class="comment">// with this situation.</span>
<a name="l00301"></a>00301         sleep(2);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="comment">// If nothing happend, return</span>
<a name="l00304"></a>00304         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306   
<a name="l00307"></a>00307     <span class="comment">// Receive exit status.</span>
<a name="l00308"></a>00308     res = <a class="code" href="invokelib_8c.html#a5bd16489ce19f6d961089212dc520c40">invoke_recv_msg</a>(fd, (uint32_t*) status);
<a name="l00309"></a>00309     <span class="keywordflow">return</span> res;
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 <span class="comment">// Sends magic number / protocol version</span>
<a name="l00313"></a><a class="code" href="invoker_8c.html#a4489ecff20505617d1fa47852dc084ac">00313</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a4489ecff20505617d1fa47852dc084ac">invoker_send_magic</a>(<span class="keywordtype">int</span> fd, uint32_t options)
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315     <span class="comment">// Send magic.</span>
<a name="l00316"></a>00316     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_MAGIC | INVOKER_MSG_MAGIC_VERSION | options);
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="comment">// Sends the process name to be invoked.</span>
<a name="l00320"></a><a class="code" href="invoker_8c.html#a0b533ae8f0cafc3ca2b39f5d69b6a182">00320</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a0b533ae8f0cafc3ca2b39f5d69b6a182">invoker_send_name</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *name)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_NAME);
<a name="l00323"></a>00323     <a class="code" href="invokelib_8c.html#ab01de067817b07ff9ecba72b78ac43ee">invoke_send_str</a>(fd, name);
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a><a class="code" href="invoker_8c.html#a7491f5afe316f69b0a3150449517c4bf">00326</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a7491f5afe316f69b0a3150449517c4bf">invoker_send_splash_file</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *filename)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_SPLASH);
<a name="l00329"></a>00329     <a class="code" href="invokelib_8c.html#ab01de067817b07ff9ecba72b78ac43ee">invoke_send_str</a>(fd, filename);
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="invoker_8c.html#ac072118ad1d48b9f96d6908d8117b288">00332</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#ac072118ad1d48b9f96d6908d8117b288">invoker_send_landscape_splash_file</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *filename)
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_LANDSCAPE_SPLASH);
<a name="l00335"></a>00335     <a class="code" href="invokelib_8c.html#ab01de067817b07ff9ecba72b78ac43ee">invoke_send_str</a>(fd, filename);
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="invoker_8c.html#a296e586aa96d9d69438440dee66075db">00338</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a296e586aa96d9d69438440dee66075db">invoker_send_exec</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *exec)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_EXEC);
<a name="l00341"></a>00341     <a class="code" href="invokelib_8c.html#ab01de067817b07ff9ecba72b78ac43ee">invoke_send_str</a>(fd, exec);
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a><a class="code" href="invoker_8c.html#af44986079fa89ac5ba4ccd3a30813104">00344</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#af44986079fa89ac5ba4ccd3a30813104">invoker_send_args</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00345"></a>00345 {
<a name="l00346"></a>00346     <span class="keywordtype">int</span> i;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_ARGS);
<a name="l00349"></a>00349     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, argc);
<a name="l00350"></a>00350     <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++)
<a name="l00351"></a>00351     {
<a name="l00352"></a>00352         debug(<span class="stringliteral">&quot;param %d %s \n&quot;</span>, i, argv[i]);
<a name="l00353"></a>00353         <a class="code" href="invokelib_8c.html#ab01de067817b07ff9ecba72b78ac43ee">invoke_send_str</a>(fd, argv[i]);
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355 }
<a name="l00356"></a>00356 
<a name="l00357"></a><a class="code" href="invoker_8c.html#a508b4368e9c0398d3c678bb5922f76b5">00357</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a508b4368e9c0398d3c678bb5922f76b5">invoker_send_prio</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> prio)
<a name="l00358"></a>00358 {
<a name="l00359"></a>00359     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_PRIO);
<a name="l00360"></a>00360     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, prio);
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">// Sends booster respawn delay</span>
<a name="l00364"></a><a class="code" href="invoker_8c.html#aaf291da6e3206d354dc8f0d36a9c7de1">00364</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#aaf291da6e3206d354dc8f0d36a9c7de1">invoker_send_delay</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> delay)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_DELAY);
<a name="l00367"></a>00367     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, delay);
<a name="l00368"></a>00368 }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 <span class="comment">// Sends UID and GID</span>
<a name="l00371"></a><a class="code" href="invoker_8c.html#afa6b143a1034bb93fddd4ebf13247159">00371</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#afa6b143a1034bb93fddd4ebf13247159">invoker_send_ids</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> uid, <span class="keywordtype">int</span> gid)
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_IDS);
<a name="l00374"></a>00374     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, uid);
<a name="l00375"></a>00375     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, gid);
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="comment">// Sends the environment variables</span>
<a name="l00379"></a><a class="code" href="invoker_8c.html#a7b3e8bf4924801854c5b8a1e3bb120f4">00379</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a7b3e8bf4924801854c5b8a1e3bb120f4">invoker_send_env</a>(<span class="keywordtype">int</span> fd)
<a name="l00380"></a>00380 {
<a name="l00381"></a>00381     <span class="keywordtype">int</span> i, n_vars;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="comment">// Count environment variables.</span>
<a name="l00384"></a>00384     <span class="keywordflow">for</span> (n_vars = 0; <a class="code" href="invoker_8c.html#aa006daaf11f1e2e45a6ababaf463212b">environ</a>[n_vars] != NULL; n_vars++) ;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_ENV);
<a name="l00387"></a>00387     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, n_vars);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="keywordflow">for</span> (i = 0; i &lt; n_vars; i++)
<a name="l00390"></a>00390     {
<a name="l00391"></a>00391         <a class="code" href="invokelib_8c.html#ab01de067817b07ff9ecba72b78ac43ee">invoke_send_str</a>(fd, <a class="code" href="invoker_8c.html#aa006daaf11f1e2e45a6ababaf463212b">environ</a>[i]);
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="keywordflow">return</span>;
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="comment">// Sends I/O descriptors</span>
<a name="l00398"></a><a class="code" href="invoker_8c.html#a980071a96e6908efa26fbd895f7dd29a">00398</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a980071a96e6908efa26fbd895f7dd29a">invoker_send_io</a>(<span class="keywordtype">int</span> fd)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400     <span class="keyword">struct </span>msghdr msg;
<a name="l00401"></a>00401     <span class="keyword">struct </span>cmsghdr *cmsg = NULL;
<a name="l00402"></a>00402     <span class="keywordtype">int</span> io[3] = { 0, 1, 2 };
<a name="l00403"></a>00403     <span class="keywordtype">char</span> buf[CMSG_SPACE(<span class="keyword">sizeof</span>(io))];
<a name="l00404"></a>00404     <span class="keyword">struct </span>iovec iov;
<a name="l00405"></a>00405     <span class="keywordtype">int</span> dummy;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     memset(&amp;msg, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msghdr));
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     iov.iov_base = &amp;dummy;
<a name="l00410"></a>00410     iov.iov_len = 1;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     msg.msg_iov = &amp;iov;
<a name="l00413"></a>00413     msg.msg_iovlen = 1;
<a name="l00414"></a>00414     msg.msg_control = buf;
<a name="l00415"></a>00415     msg.msg_controllen = <span class="keyword">sizeof</span>(buf);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     cmsg = CMSG_FIRSTHDR(&amp;msg);
<a name="l00418"></a>00418     cmsg-&gt;cmsg_len = CMSG_LEN(<span class="keyword">sizeof</span>(io));
<a name="l00419"></a>00419     cmsg-&gt;cmsg_level = SOL_SOCKET;
<a name="l00420"></a>00420     cmsg-&gt;cmsg_type = SCM_RIGHTS;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     memcpy(CMSG_DATA(cmsg), io, <span class="keyword">sizeof</span>(io));
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     msg.msg_controllen = cmsg-&gt;cmsg_len;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_IO);
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (sendmsg(fd, &amp;msg, 0) &lt; 0)
<a name="l00428"></a>00428     {
<a name="l00429"></a>00429         warning(<span class="stringliteral">&quot;sendmsg failed in invoker_send_io: %s \n&quot;</span>, strerror(errno));
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="keywordflow">return</span>;
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="comment">// Sends the END message</span>
<a name="l00436"></a><a class="code" href="invoker_8c.html#ac0243967aa00e4d76c7fac12c5eb7074">00436</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#ac0243967aa00e4d76c7fac12c5eb7074">invoker_send_end</a>(<span class="keywordtype">int</span> fd)
<a name="l00437"></a>00437 {
<a name="l00438"></a>00438     <a class="code" href="invokelib_8c.html#a2e4319a3b5e5c3c1479f43cd79720a4a">invoke_send_msg</a>(fd, INVOKER_MSG_END);
<a name="l00439"></a>00439     <a class="code" href="invoker_8c.html#af3be588b0f5f31deba1f8a83671be134">invoke_recv_ack</a>(fd);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="comment">// Prints the usage and exits with given status</span>
<a name="l00444"></a><a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">00444</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">usage</a>(<span class="keywordtype">int</span> status)
<a name="l00445"></a>00445 {
<a name="l00446"></a>00446     printf(<span class="stringliteral">&quot;\nUsage: %s [options] [--type=TYPE] [file] [args]\n\n&quot;</span>
<a name="l00447"></a>00447            <span class="stringliteral">&quot;Launch m, qt, or qdeclarative application compiled as a shared library (-shared) or\n&quot;</span>
<a name="l00448"></a>00448            <span class="stringliteral">&quot;a position independent executable (-pie) through %s.\n\n&quot;</span>
<a name="l00449"></a>00449            <span class="stringliteral">&quot;TYPE chooses the type of booster used. Qt-booster may be used to\n&quot;</span>
<a name="l00450"></a>00450            <span class="stringliteral">&quot;launch anything. Possible values for TYPE:\n&quot;</span>
<a name="l00451"></a>00451            <span class="stringliteral">&quot;  m                      Launch a MeeGo Touch application.\n&quot;</span>
<a name="l00452"></a>00452            <span class="stringliteral">&quot;  q (or qt)              Launch a Qt application.\n&quot;</span>
<a name="l00453"></a>00453            <span class="stringliteral">&quot;  d                      Launch a Qt Declarative (QML) application.\n&quot;</span>
<a name="l00454"></a>00454            <span class="stringliteral">&quot;  e                      Launch any application, even if it&#39;s not a library.\n&quot;</span>
<a name="l00455"></a>00455            <span class="stringliteral">&quot;                         Can be used if only splash screen is wanted.\n\n&quot;</span>
<a name="l00456"></a>00456            <span class="stringliteral">&quot;Options:\n&quot;</span>
<a name="l00457"></a>00457            <span class="stringliteral">&quot;  -c, --creds            Print Aegis security credentials (if enabled).\n&quot;</span>
<a name="l00458"></a>00458            <span class="stringliteral">&quot;  -d, --delay SECS       After invoking sleep for SECS seconds\n&quot;</span>
<a name="l00459"></a>00459            <span class="stringliteral">&quot;                         (default %d).\n&quot;</span>
<a name="l00460"></a>00460            <span class="stringliteral">&quot;  -r, --respawn SECS     After invoking respawn new booster after SECS seconds\n&quot;</span>
<a name="l00461"></a>00461            <span class="stringliteral">&quot;                         (default %d, max %d).\n&quot;</span>
<a name="l00462"></a>00462            <span class="stringliteral">&quot;  -w, --wait-term        Wait for launched process to terminate (default).\n&quot;</span>
<a name="l00463"></a>00463            <span class="stringliteral">&quot;  -n, --no-wait          Do not wait for launched process to terminate.\n&quot;</span>
<a name="l00464"></a>00464            <span class="stringliteral">&quot;  -G, --global-syms      Places symbols in the application binary and its\n&quot;</span>
<a name="l00465"></a>00465            <span class="stringliteral">&quot;                         libraries to the global scope.\n&quot;</span>
<a name="l00466"></a>00466            <span class="stringliteral">&quot;                         See RTLD_GLOBAL in the dlopen manual page.\n&quot;</span>
<a name="l00467"></a>00467            <span class="stringliteral">&quot;  -s, --single-instance  Launch the application as a single instance.\n&quot;</span>
<a name="l00468"></a>00468            <span class="stringliteral">&quot;                         The existing application window will be activated\n&quot;</span>
<a name="l00469"></a>00469            <span class="stringliteral">&quot;                         if already launched.\n&quot;</span>
<a name="l00470"></a>00470            <span class="stringliteral">&quot;  -S, --splash FILE      Show splash screen from the FILE.\n&quot;</span>
<a name="l00471"></a>00471            <span class="stringliteral">&quot;  -L, --splash-landscape LANDSCAPE-FILE\n&quot;</span>
<a name="l00472"></a>00472            <span class="stringliteral">&quot;                         Show splash screen from the LANDSCAPE-FILE\n&quot;</span>
<a name="l00473"></a>00473            <span class="stringliteral">&quot;                         in case the device is in landscape orientation.\n&quot;</span>
<a name="l00474"></a>00474            <span class="stringliteral">&quot;  -o, --daemon-mode      Notify invoker that the launched process is a daemon.\n&quot;</span>
<a name="l00475"></a>00475            <span class="stringliteral">&quot;                         This resets the oom_adj of the process.\n&quot;</span>
<a name="l00476"></a>00476            <span class="stringliteral">&quot;  -h, --help             Print this help.\n\n&quot;</span>
<a name="l00477"></a>00477            <span class="stringliteral">&quot;Example: %s --type=m /usr/bin/helloworld\n\n&quot;</span>,
<a name="l00478"></a>00478            PROG_NAME_INVOKER, PROG_NAME_LAUNCHER, <a class="code" href="invoker_8c.html#a9e7b9832d61aae7a2c1345064116296b">EXIT_DELAY</a>, <a class="code" href="invoker_8c.html#a50cc5943369c2b7f9b2175ca58ce6ec5">RESPAWN_DELAY</a>, <a class="code" href="invoker_8c.html#a94a1c34b76008f80bed1ad20853a11a6">MAX_RESPAWN_DELAY</a>, PROG_NAME_INVOKER);
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     exit(status);
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="comment">// Return delay as integer </span>
<a name="l00484"></a><a class="code" href="invoker_8c.html#acd41bafd1db0ad2ceb7a1615d6afe932">00484</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#acd41bafd1db0ad2ceb7a1615d6afe932">get_delay</a>(<span class="keywordtype">char</span> *delay_arg, <span class="keywordtype">char</span> *param_name,
<a name="l00485"></a>00485                               <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_value, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_value)
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> delay = <a class="code" href="invoker_8c.html#a9e7b9832d61aae7a2c1345064116296b">EXIT_DELAY</a>;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="keywordflow">if</span> (delay_arg)
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491         errno = 0; <span class="comment">// To distinguish success/failure after call</span>
<a name="l00492"></a>00492         delay = strtoul(delay_arg, NULL, 10);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <span class="comment">// Check for various possible errors</span>
<a name="l00495"></a>00495         <span class="keywordflow">if</span> ((errno == ERANGE &amp;&amp; delay == ULONG_MAX)
<a name="l00496"></a>00496             || delay &lt; min_value
<a name="l00497"></a>00497             || delay &gt; max_value)
<a name="l00498"></a>00498         {
<a name="l00499"></a>00499             report(report_error, <span class="stringliteral">&quot;Wrong value of %s parameter: %s\n&quot;</span>, param_name, delay_arg);
<a name="l00500"></a>00500             <a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">usage</a>(1);
<a name="l00501"></a>00501         }
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503     
<a name="l00504"></a>00504     <span class="keywordflow">return</span> delay;
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="invoker_8c.html#aad2be66fc4208b23481141f09e9896ed">00507</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#aad2be66fc4208b23481141f09e9896ed">wait_for_launched_process_to_exit</a>(<span class="keywordtype">int</span> socket_fd, <span class="keywordtype">bool</span> wait_term)
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509     <span class="keywordtype">int</span> status = 0;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="comment">// Wait for launched process to exit</span>
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (wait_term)
<a name="l00513"></a>00513     {
<a name="l00514"></a>00514         <span class="comment">// coverity[tainted_string_return_content]</span>
<a name="l00515"></a>00515         <a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a> = <a class="code" href="invoker_8c.html#adda5347bd0fada2e1aa680cdf215d295">invoker_recv_pid</a>(socket_fd);
<a name="l00516"></a>00516         debug(<span class="stringliteral">&quot;Booster&#39;s pid is %d \n &quot;</span>, <a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518         <span class="comment">// Forward UNIX signals to the invoked process</span>
<a name="l00519"></a>00519         <a class="code" href="invoker_8c.html#a619bc4e34f22792efa8a46db6b2084b0">sigs_init</a>();
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <span class="keywordflow">while</span>(1)
<a name="l00522"></a>00522         {
<a name="l00523"></a>00523             <span class="comment">// Setup things for select()</span>
<a name="l00524"></a>00524             fd_set readfds;
<a name="l00525"></a>00525             <span class="keywordtype">int</span> ndfs = 0;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527             FD_ZERO(&amp;readfds);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529             FD_SET(socket_fd, &amp;readfds);
<a name="l00530"></a>00530             ndfs = (socket_fd &gt; ndfs) ? socket_fd : ndfs;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532             <span class="comment">// sig_forwarder() handles signals.</span>
<a name="l00533"></a>00533             <span class="comment">// We only have to receive those here.</span>
<a name="l00534"></a>00534             FD_SET(<a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>[0], &amp;readfds);
<a name="l00535"></a>00535             ndfs = (<a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>[0] &gt; ndfs) ? <a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>[0] : ndfs;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537             <span class="comment">// Wait for something appearing in the pipes.</span>
<a name="l00538"></a>00538             <span class="keywordflow">if</span> (select(ndfs + 1, &amp;readfds, NULL, NULL, NULL) &gt; 0)
<a name="l00539"></a>00539             {
<a name="l00540"></a>00540                 <span class="comment">// Check if an exit status from the invoked application</span>
<a name="l00541"></a>00541                 <span class="keywordflow">if</span> (FD_ISSET(socket_fd, &amp;readfds))
<a name="l00542"></a>00542                 {
<a name="l00543"></a>00543                     <span class="keywordtype">bool</span> res = <a class="code" href="invoker_8c.html#adb904f45873b687b7eae3e04758ba933">invoker_recv_exit</a>(socket_fd, &amp;status);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545                     <span class="keywordflow">if</span> (!res)
<a name="l00546"></a>00546                     {
<a name="l00547"></a>00547                         <span class="comment">// Because we are here, applauncherd.bin must be dead.</span>
<a name="l00548"></a>00548                         <span class="comment">// Now we check if the invoked process is also dead</span>
<a name="l00549"></a>00549                         <span class="comment">// and if not, we will kill it.</span>
<a name="l00550"></a>00550                         <span class="keywordtype">char</span> filename[50];
<a name="l00551"></a>00551                         snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;/proc/%d/cmdline&quot;</span>, <a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a>);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553                         <span class="comment">// Open filename for reading only</span>
<a name="l00554"></a>00554                         <span class="keywordtype">int</span> fd = open(filename, O_RDONLY);
<a name="l00555"></a>00555                         <span class="keywordflow">if</span> (fd != -1)
<a name="l00556"></a>00556                         {
<a name="l00557"></a>00557                             <span class="comment">// Application is still running</span>
<a name="l00558"></a>00558                             close(fd);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560                             <span class="comment">// Send a signal to kill the application too and exit.</span>
<a name="l00561"></a>00561                             <span class="comment">// Sleep for some time to give</span>
<a name="l00562"></a>00562                             <span class="comment">// the new applauncherd some time to load its boosters and</span>
<a name="l00563"></a>00563                             <span class="comment">// the restart of g_invoked_pid succeeds.</span>
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                             sleep(10);
<a name="l00566"></a>00566                             kill(<a class="code" href="invoker_8c.html#a97c60b369529d56b4b38bcff38c275dc">g_invoked_pid</a>, SIGKILL);
<a name="l00567"></a>00567                             <span class="keyword">raise</span>(SIGKILL);
<a name="l00568"></a>00568                         }
<a name="l00569"></a>00569                         <span class="keywordflow">else</span>
<a name="l00570"></a>00570                         {
<a name="l00571"></a>00571                             <span class="comment">// connection to application was lost</span>
<a name="l00572"></a>00572                             status = EXIT_FAILURE; 
<a name="l00573"></a>00573                         }
<a name="l00574"></a>00574                     }
<a name="l00575"></a>00575                     <span class="keywordflow">break</span>;
<a name="l00576"></a>00576                 }
<a name="l00577"></a>00577                 <span class="comment">// Check if we got a UNIX signal.</span>
<a name="l00578"></a>00578                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FD_ISSET(<a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>[0], &amp;readfds))
<a name="l00579"></a>00579                 {
<a name="l00580"></a>00580                     <span class="comment">// Clean up the pipe</span>
<a name="l00581"></a>00581                     <span class="keywordtype">char</span> signal_id;
<a name="l00582"></a>00582                     read(<a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>[0], &amp;signal_id, <span class="keyword">sizeof</span>(signal_id));
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                     <span class="comment">// Set signals forwarding to the invoked process again</span>
<a name="l00585"></a>00585                     <span class="comment">// (they were reset by the signal forwarder).</span>
<a name="l00586"></a>00586                     <a class="code" href="invoker_8c.html#a619bc4e34f22792efa8a46db6b2084b0">sigs_init</a>();
<a name="l00587"></a>00587                 }
<a name="l00588"></a>00588             }
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <span class="comment">// Restore default signal handlers</span>
<a name="l00592"></a>00592         <a class="code" href="invoker_8c.html#af38ccce065ad2dd315f08a9af1bdb2b4">sigs_restore</a>();
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     <span class="keywordflow">return</span> status;
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 <span class="comment">// &quot;normal&quot; invoke through a socket connection</span>
<a name="l00599"></a><a class="code" href="invoker_8c.html#a42784a4f66b972ab416a1b1f40b69234">00599</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a42784a4f66b972ab416a1b1f40b69234">invoke_remote</a>(<span class="keywordtype">int</span> socket_fd, <span class="keywordtype">int</span> prog_argc, <span class="keywordtype">char</span> **prog_argv, <span class="keywordtype">char</span> *prog_name,
<a name="l00600"></a>00600                          uint32_t magic_options, <span class="keywordtype">bool</span> wait_term, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> respawn_delay,
<a name="l00601"></a>00601                          <span class="keywordtype">char</span> *splash_file, <span class="keywordtype">char</span> *landscape_splash_file)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603     <span class="comment">// Get process priority</span>
<a name="l00604"></a>00604     errno = 0;
<a name="l00605"></a>00605     <span class="keywordtype">int</span> prog_prio = getpriority(PRIO_PROCESS, 0);
<a name="l00606"></a>00606     <span class="keywordflow">if</span> (errno &amp;&amp; prog_prio &lt; 0)
<a name="l00607"></a>00607     {
<a name="l00608"></a>00608         prog_prio = 0;
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     <span class="comment">// Connection with launcher process is established,</span>
<a name="l00612"></a>00612     <span class="comment">// send the data.</span>
<a name="l00613"></a>00613     <a class="code" href="invoker_8c.html#a4489ecff20505617d1fa47852dc084ac">invoker_send_magic</a>(socket_fd, magic_options);
<a name="l00614"></a>00614     <a class="code" href="invoker_8c.html#a0b533ae8f0cafc3ca2b39f5d69b6a182">invoker_send_name</a>(socket_fd, prog_argv[0]);
<a name="l00615"></a>00615     <a class="code" href="invoker_8c.html#a296e586aa96d9d69438440dee66075db">invoker_send_exec</a>(socket_fd, prog_name);
<a name="l00616"></a>00616     <a class="code" href="invoker_8c.html#af44986079fa89ac5ba4ccd3a30813104">invoker_send_args</a>(socket_fd, prog_argc, prog_argv);
<a name="l00617"></a>00617     <a class="code" href="invoker_8c.html#a508b4368e9c0398d3c678bb5922f76b5">invoker_send_prio</a>(socket_fd, prog_prio);
<a name="l00618"></a>00618     <a class="code" href="invoker_8c.html#aaf291da6e3206d354dc8f0d36a9c7de1">invoker_send_delay</a>(socket_fd, respawn_delay);
<a name="l00619"></a>00619     <a class="code" href="invoker_8c.html#afa6b143a1034bb93fddd4ebf13247159">invoker_send_ids</a>(socket_fd, getuid(), getgid());
<a name="l00620"></a>00620     <span class="keywordflow">if</span> (( magic_options &amp; INVOKER_MSG_MAGIC_OPTION_SPLASH_SCREEN ) != 0)
<a name="l00621"></a>00621         <a class="code" href="invoker_8c.html#a7491f5afe316f69b0a3150449517c4bf">invoker_send_splash_file</a>(socket_fd, splash_file);
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (( magic_options &amp; INVOKER_MSG_MAGIC_OPTION_LANDSCAPE_SPLASH_SCREEN ) != 0)
<a name="l00623"></a>00623         <a class="code" href="invoker_8c.html#ac072118ad1d48b9f96d6908d8117b288">invoker_send_landscape_splash_file</a>(socket_fd, landscape_splash_file);
<a name="l00624"></a>00624     <a class="code" href="invoker_8c.html#a980071a96e6908efa26fbd895f7dd29a">invoker_send_io</a>(socket_fd);
<a name="l00625"></a>00625     <a class="code" href="invoker_8c.html#a7b3e8bf4924801854c5b8a1e3bb120f4">invoker_send_env</a>(socket_fd);
<a name="l00626"></a>00626     <a class="code" href="invoker_8c.html#ac0243967aa00e4d76c7fac12c5eb7074">invoker_send_end</a>(socket_fd);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="keywordflow">if</span> (prog_name)
<a name="l00629"></a>00629     {
<a name="l00630"></a>00630         free(prog_name);
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     <span class="keywordtype">int</span> exit_status = <a class="code" href="invoker_8c.html#aad2be66fc4208b23481141f09e9896ed">wait_for_launched_process_to_exit</a>(socket_fd, wait_term);
<a name="l00634"></a>00634     <span class="keywordflow">return</span> exit_status;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a><a class="code" href="invoker_8c.html#a3a359b43ccf2fd1a063935fb9d357eaf">00637</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="invoker_8c.html#a3a359b43ccf2fd1a063935fb9d357eaf">invoke_fallback</a>(<span class="keywordtype">char</span> **prog_argv, <span class="keywordtype">char</span> *prog_name, <span class="keywordtype">bool</span> wait_term)
<a name="l00638"></a>00638 {
<a name="l00639"></a>00639     <span class="comment">// Connection with launcher is broken,</span>
<a name="l00640"></a>00640     <span class="comment">// try to launch application via execve</span>
<a name="l00641"></a>00641     warning(<span class="stringliteral">&quot;Connection with launcher process is broken. \n&quot;</span>);
<a name="l00642"></a>00642     error(<span class="stringliteral">&quot;Start application %s as a binary executable without launcher...\n&quot;</span>, prog_name);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     <span class="comment">// Fork if wait_term not set</span>
<a name="l00645"></a>00645     <span class="keywordflow">if</span>(!wait_term)
<a name="l00646"></a>00646     {
<a name="l00647"></a>00647         <span class="comment">// Fork a new process</span>
<a name="l00648"></a>00648         pid_t newPid = fork();
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <span class="keywordflow">if</span> (newPid == -1)
<a name="l00651"></a>00651         {
<a name="l00652"></a>00652             error(<span class="stringliteral">&quot;Invoker failed to fork. \n&quot;</span>);
<a name="l00653"></a>00653             exit(EXIT_FAILURE);
<a name="l00654"></a>00654         }
<a name="l00655"></a>00655         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (newPid != 0) <span class="comment">/* parent process */</span>
<a name="l00656"></a>00656         {
<a name="l00657"></a>00657             <span class="keywordflow">return</span>;
<a name="l00658"></a>00658         }
<a name="l00659"></a>00659     }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661     <span class="comment">// Exec the process image</span>
<a name="l00662"></a>00662     execve(prog_name, prog_argv, <a class="code" href="invoker_8c.html#aa006daaf11f1e2e45a6ababaf463212b">environ</a>);
<a name="l00663"></a>00663     perror(<span class="stringliteral">&quot;execve&quot;</span>);   <span class="comment">/* execve() only returns on error */</span>
<a name="l00664"></a>00664     exit(EXIT_FAILURE);
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667 <span class="comment">// Invokes the given application</span>
<a name="l00668"></a><a class="code" href="invoker_8c.html#a24c195eae2b6e4670ab2bab261f10022">00668</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a24c195eae2b6e4670ab2bab261f10022">invoke</a>(<span class="keywordtype">int</span> prog_argc, <span class="keywordtype">char</span> **prog_argv, <span class="keywordtype">char</span> *prog_name,
<a name="l00669"></a>00669                   <span class="keyword">enum</span> <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160">APP_TYPE</a> app_type, uint32_t magic_options, <span class="keywordtype">bool</span> wait_term, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> respawn_delay,
<a name="l00670"></a>00670                   <span class="keywordtype">char</span> *splash_file, <span class="keywordtype">char</span> *landscape_splash_file)
<a name="l00671"></a>00671 {
<a name="l00672"></a>00672     <span class="keywordtype">int</span> status = 0;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674     <span class="keywordflow">if</span> (prog_name &amp;&amp; prog_argv)
<a name="l00675"></a>00675     {
<a name="l00676"></a>00676         <span class="comment">// This is a fallback if connection with the launcher</span>
<a name="l00677"></a>00677         <span class="comment">// process is broken       </span>
<a name="l00678"></a>00678         <span class="keywordtype">int</span> fd = <a class="code" href="invoker_8c.html#aef14fae16666ae75d89dcaf6fa741ea3">invoker_init</a>(app_type);
<a name="l00679"></a>00679         <span class="keywordflow">if</span> (fd == -1)
<a name="l00680"></a>00680         {
<a name="l00681"></a>00681             <a class="code" href="invoker_8c.html#a3a359b43ccf2fd1a063935fb9d357eaf">invoke_fallback</a>(prog_argv, prog_name, wait_term);
<a name="l00682"></a>00682         }
<a name="l00683"></a>00683         <span class="comment">// &quot;normal&quot; invoke through a socket connetion</span>
<a name="l00684"></a>00684         <span class="keywordflow">else</span>
<a name="l00685"></a>00685         {
<a name="l00686"></a>00686             status = <a class="code" href="invoker_8c.html#a42784a4f66b972ab416a1b1f40b69234">invoke_remote</a>(fd, prog_argc, prog_argv, prog_name,
<a name="l00687"></a>00687                                    magic_options, wait_term, respawn_delay,
<a name="l00688"></a>00688                                    splash_file, landscape_splash_file);
<a name="l00689"></a>00689             close(fd);
<a name="l00690"></a>00690         }
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692     
<a name="l00693"></a>00693     <span class="keywordflow">return</span> status;
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a><a class="code" href="invoker_8c.html#a0ddf1224851353fc92bfbff6f499fa97">00696</a> <span class="keywordtype">int</span> <a class="code" href="invoker_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698     <span class="keyword">enum</span> <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160">APP_TYPE</a> app_type      = UNKNOWN_APP;
<a name="l00699"></a>00699     <span class="keywordtype">int</span>           prog_argc     = 0;
<a name="l00700"></a>00700     uint32_t      magic_options = 0;
<a name="l00701"></a>00701     <span class="keywordtype">bool</span>          wait_term     = <span class="keyword">true</span>;
<a name="l00702"></a>00702     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  delay         = <a class="code" href="invoker_8c.html#a9e7b9832d61aae7a2c1345064116296b">EXIT_DELAY</a>;
<a name="l00703"></a>00703     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  respawn_delay = <a class="code" href="invoker_8c.html#a50cc5943369c2b7f9b2175ca58ce6ec5">RESPAWN_DELAY</a>;
<a name="l00704"></a>00704     <span class="keywordtype">char</span>        **prog_argv     = NULL;
<a name="l00705"></a>00705     <span class="keywordtype">char</span>         *prog_name     = NULL;
<a name="l00706"></a>00706     <span class="keywordtype">char</span>         *splash_file   = NULL;
<a name="l00707"></a>00707     <span class="keywordtype">char</span>         *landscape_splash_file = NULL;
<a name="l00708"></a>00708     <span class="keyword">struct </span>stat   file_stat;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="comment">// wait-term parameter by default</span>
<a name="l00711"></a>00711     magic_options |= INVOKER_MSG_MAGIC_OPTION_WAIT;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <span class="comment">// Called with a different name (old way of using invoker) ?</span>
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (!strstr(argv[0], PROG_NAME_INVOKER) )
<a name="l00715"></a>00715     {
<a name="l00716"></a>00716         die(1,
<a name="l00717"></a>00717             <span class="stringliteral">&quot;Incorrect use of invoker, don&#39;t use symlinks. &quot;</span>
<a name="l00718"></a>00718             <span class="stringliteral">&quot;Run invoker explicitly from e.g. a D-Bus service file instead.\n&quot;</span>);
<a name="l00719"></a>00719     }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     <span class="comment">// Stops parsing args as soon as a non-option argument is encountered</span>
<a name="l00722"></a>00722     putenv(<span class="stringliteral">&quot;POSIXLY_CORRECT=1&quot;</span>);
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <span class="comment">// Options recognized</span>
<a name="l00725"></a>00725     <span class="keyword">struct </span>option longopts[] = {
<a name="l00726"></a>00726         {<span class="stringliteral">&quot;help&quot;</span>,             no_argument,       NULL, <span class="charliteral">&#39;h&#39;</span>},
<a name="l00727"></a>00727         {<span class="stringliteral">&quot;creds&quot;</span>,            no_argument,       NULL, <span class="charliteral">&#39;c&#39;</span>},
<a name="l00728"></a>00728         {<span class="stringliteral">&quot;wait-term&quot;</span>,        no_argument,       NULL, <span class="charliteral">&#39;w&#39;</span>},
<a name="l00729"></a>00729         {<span class="stringliteral">&quot;no-wait&quot;</span>,          no_argument,       NULL, <span class="charliteral">&#39;n&#39;</span>},
<a name="l00730"></a>00730         {<span class="stringliteral">&quot;global-syms&quot;</span>,      no_argument,       NULL, <span class="charliteral">&#39;G&#39;</span>},
<a name="l00731"></a>00731         {<span class="stringliteral">&quot;deep-syms&quot;</span>,        no_argument,       NULL, <span class="charliteral">&#39;D&#39;</span>},
<a name="l00732"></a>00732         {<span class="stringliteral">&quot;single-instance&quot;</span>,  no_argument,       NULL, <span class="charliteral">&#39;s&#39;</span>},
<a name="l00733"></a>00733         {<span class="stringliteral">&quot;daemon-mode&quot;</span>,      no_argument,       NULL, <span class="charliteral">&#39;o&#39;</span>},
<a name="l00734"></a>00734         {<span class="stringliteral">&quot;type&quot;</span>,             required_argument, NULL, <span class="charliteral">&#39;t&#39;</span>},
<a name="l00735"></a>00735         {<span class="stringliteral">&quot;delay&quot;</span>,            required_argument, NULL, <span class="charliteral">&#39;d&#39;</span>},
<a name="l00736"></a>00736         {<span class="stringliteral">&quot;respawn&quot;</span>,          required_argument, NULL, <span class="charliteral">&#39;r&#39;</span>},
<a name="l00737"></a>00737         {<span class="stringliteral">&quot;splash&quot;</span>,           required_argument, NULL, <span class="charliteral">&#39;S&#39;</span>},
<a name="l00738"></a>00738         {<span class="stringliteral">&quot;splash-landscape&quot;</span>, required_argument, NULL, <span class="charliteral">&#39;L&#39;</span>},
<a name="l00739"></a>00739         {0, 0, 0, 0}
<a name="l00740"></a>00740     };
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="comment">// Parse options</span>
<a name="l00743"></a>00743     <span class="comment">// TODO: Move to a function</span>
<a name="l00744"></a>00744     <span class="keywordtype">int</span> opt;
<a name="l00745"></a>00745     <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;hcwnGDsod:t:r:S:L:&quot;</span>, longopts, NULL)) != -1)
<a name="l00746"></a>00746     {
<a name="l00747"></a>00747         <span class="keywordflow">switch</span>(opt)
<a name="l00748"></a>00748         {
<a name="l00749"></a>00749         <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:
<a name="l00750"></a>00750             <a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">usage</a>(0);
<a name="l00751"></a>00751             <span class="keywordflow">break</span>;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:
<a name="l00754"></a>00754             <a class="code" href="invoker_8c.html#a6ac061f008827b81a8dfe0f99c284fa7">show_credentials</a>();
<a name="l00755"></a>00755             <span class="keywordflow">break</span>;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757         <span class="keywordflow">case</span> <span class="charliteral">&#39;w&#39;</span>:
<a name="l00758"></a>00758             <span class="comment">// nothing to do, it&#39;s by default now</span>
<a name="l00759"></a>00759             <span class="keywordflow">break</span>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:
<a name="l00762"></a>00762             magic_options |= INVOKER_MSG_MAGIC_OPTION_OOM_ADJ_DISABLE;
<a name="l00763"></a>00763             <span class="keywordflow">break</span>;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765         <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:
<a name="l00766"></a>00766             wait_term = <span class="keyword">false</span>;
<a name="l00767"></a>00767             magic_options &amp;= (~INVOKER_MSG_MAGIC_OPTION_WAIT);
<a name="l00768"></a>00768             <span class="keywordflow">break</span>;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770         <span class="keywordflow">case</span> <span class="charliteral">&#39;G&#39;</span>:
<a name="l00771"></a>00771             magic_options |= INVOKER_MSG_MAGIC_OPTION_DLOPEN_GLOBAL;
<a name="l00772"></a>00772             <span class="keywordflow">break</span>;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774         <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span>:
<a name="l00775"></a>00775             magic_options |= INVOKER_MSG_MAGIC_OPTION_DLOPEN_DEEP;
<a name="l00776"></a>00776             <span class="keywordflow">break</span>;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778         <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:
<a name="l00779"></a>00779             <span class="keywordflow">if</span> (strcmp(optarg, <span class="stringliteral">&quot;m&quot;</span>) == 0)
<a name="l00780"></a>00780                 app_type = <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160aedd7954fb75ba9170bdc9ad2896a82c7">M_APP</a>;
<a name="l00781"></a>00781             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(optarg, <span class="stringliteral">&quot;q&quot;</span>) == 0 || strcmp(optarg, <span class="stringliteral">&quot;qt&quot;</span>) == 0)
<a name="l00782"></a>00782                 app_type = <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160abe24a6ebdbce172f642f28c23d4e9aa6">QT_APP</a>;
<a name="l00783"></a>00783             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(optarg, <span class="stringliteral">&quot;d&quot;</span>) == 0)
<a name="l00784"></a>00784                 app_type = <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160a1dac251c9da0be6bc43bbe78514e69f5">QDECL_APP</a>;
<a name="l00785"></a>00785             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(optarg, <span class="stringliteral">&quot;e&quot;</span>) == 0)
<a name="l00786"></a>00786                 app_type = <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160a59e0746009b7ba1166cdd4e4405f4f64">EXEC_APP</a>;
<a name="l00787"></a>00787             <span class="keywordflow">else</span>
<a name="l00788"></a>00788             {
<a name="l00789"></a>00789                 report(report_error, <span class="stringliteral">&quot;Unknown application type: %s \n&quot;</span>, optarg);
<a name="l00790"></a>00790                 <a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">usage</a>(1);
<a name="l00791"></a>00791             }
<a name="l00792"></a>00792             <span class="keywordflow">break</span>;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:
<a name="l00795"></a>00795             delay = <a class="code" href="invoker_8c.html#acd41bafd1db0ad2ceb7a1615d6afe932">get_delay</a>(optarg, <span class="stringliteral">&quot;delay&quot;</span>, <a class="code" href="invoker_8c.html#a5ed2b2b88f84b3b2d8271a1b8b9408ce">MIN_EXIT_DELAY</a>, <a class="code" href="invoker_8c.html#a998f7d8bd1b495cbe14c695157419b22">MAX_EXIT_DELAY</a>);
<a name="l00796"></a>00796             <span class="keywordflow">break</span>;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798         <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:
<a name="l00799"></a>00799             respawn_delay = <a class="code" href="invoker_8c.html#acd41bafd1db0ad2ceb7a1615d6afe932">get_delay</a>(optarg, <span class="stringliteral">&quot;respawn delay&quot;</span>,
<a name="l00800"></a>00800                                       <a class="code" href="invoker_8c.html#aeb3a737958b9a0ae5d7b90def707bec2">MIN_RESPAWN_DELAY</a>, <a class="code" href="invoker_8c.html#a94a1c34b76008f80bed1ad20853a11a6">MAX_RESPAWN_DELAY</a>);
<a name="l00801"></a>00801             <span class="keywordflow">break</span>;
<a name="l00802"></a>00802 
<a name="l00803"></a>00803         <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:
<a name="l00804"></a>00804             magic_options |= INVOKER_MSG_MAGIC_OPTION_SINGLE_INSTANCE;
<a name="l00805"></a>00805             <span class="keywordflow">break</span>;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:
<a name="l00808"></a>00808             magic_options |= INVOKER_MSG_MAGIC_OPTION_SPLASH_SCREEN;
<a name="l00809"></a>00809             splash_file = optarg;
<a name="l00810"></a>00810             <span class="keywordflow">break</span>;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>:
<a name="l00813"></a>00813             magic_options |= INVOKER_MSG_MAGIC_OPTION_LANDSCAPE_SPLASH_SCREEN;
<a name="l00814"></a>00814             landscape_splash_file = optarg;
<a name="l00815"></a>00815             <span class="keywordflow">break</span>;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:
<a name="l00818"></a>00818             <a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">usage</a>(1);
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     <span class="comment">// Option processing stops as soon as application name is encountered</span>
<a name="l00823"></a>00823     <span class="keywordflow">if</span> (optind &lt; argc)
<a name="l00824"></a>00824     {
<a name="l00825"></a>00825         prog_name = <a class="code" href="search_8c.html#a0e6e5ba6d88e725d287013c0b4fa39d0">search_program</a>(argv[optind]);
<a name="l00826"></a>00826         prog_argc = argc - optind;
<a name="l00827"></a>00827         prog_argv = &amp;argv[optind];
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="comment">// Check if application name isn&#39;t defined</span>
<a name="l00831"></a>00831     <span class="keywordflow">if</span> (!prog_name)
<a name="l00832"></a>00832     {
<a name="l00833"></a>00833         report(report_error, <span class="stringliteral">&quot;Application&#39;s name is not defined.\n&quot;</span>);
<a name="l00834"></a>00834         <a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">usage</a>(1);
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     <span class="comment">// Check if application exists</span>
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (stat(prog_name, &amp;file_stat))
<a name="l00839"></a>00839     {
<a name="l00840"></a>00840         report(report_error, <span class="stringliteral">&quot;%s: not found\n&quot;</span>, prog_name);
<a name="l00841"></a>00841         <span class="keywordflow">return</span> <a class="code" href="invoker_8c.html#afb265efdef0a25752de2a080d56f4fa8">EXIT_STATUS_APPLICATION_NOT_FOUND</a>;
<a name="l00842"></a>00842     }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="comment">// Check that </span>
<a name="l00845"></a>00845     <span class="keywordflow">if</span> (!S_ISREG(file_stat.st_mode) &amp;&amp; !S_ISLNK(file_stat.st_mode))
<a name="l00846"></a>00846     {
<a name="l00847"></a>00847         report(report_error, <span class="stringliteral">&quot;%s: not a file\n&quot;</span>, prog_name);
<a name="l00848"></a>00848         <span class="keywordflow">return</span> <a class="code" href="invoker_8c.html#afb265efdef0a25752de2a080d56f4fa8">EXIT_STATUS_APPLICATION_NOT_FOUND</a>;
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     <span class="comment">// Check if application type is unknown</span>
<a name="l00852"></a>00852     <span class="keywordflow">if</span> (app_type == <a class="code" href="invoker_8c.html#adfd0792c906e58759e33e161ebaaa160aa33303291086103c32a6fe8f170c953f">UNKNOWN_APP</a>)
<a name="l00853"></a>00853     {
<a name="l00854"></a>00854         report(report_error, <span class="stringliteral">&quot;Application&#39;s type is unknown.\n&quot;</span>);
<a name="l00855"></a>00855         <a class="code" href="invoker_8c.html#a3c83d9a6df948871c9355ef7f15738a5">usage</a>(1);
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="keywordflow">if</span> (pipe(<a class="code" href="invoker_8c.html#a7316cc6af9d04132b3715730cf300100" title="Pipe used to safely catch Unix signals.">g_signal_pipe</a>) == -1)
<a name="l00859"></a>00859     { 
<a name="l00860"></a>00860         report(report_error, <span class="stringliteral">&quot;Creating a pipe for Unix signals failed!\n&quot;</span>); 
<a name="l00861"></a>00861         exit(EXIT_FAILURE); 
<a name="l00862"></a>00862     }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 
<a name="l00865"></a>00865     <span class="comment">// Send commands to the launcher daemon</span>
<a name="l00866"></a>00866     info(<span class="stringliteral">&quot;Invoking execution: &#39;%s&#39;\n&quot;</span>, prog_name);
<a name="l00867"></a>00867     <span class="keywordtype">int</span> ret_val = <a class="code" href="invoker_8c.html#a24c195eae2b6e4670ab2bab261f10022">invoke</a>(prog_argc, prog_argv, prog_name, app_type, magic_options, wait_term, respawn_delay, splash_file, landscape_splash_file);
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     <span class="comment">// Sleep for delay before exiting</span>
<a name="l00870"></a>00870     <span class="keywordflow">if</span> (delay)
<a name="l00871"></a>00871     {
<a name="l00872"></a>00872         <span class="comment">// DBUS cannot cope some times if the invoker exits too early.</span>
<a name="l00873"></a>00873         debug(<span class="stringliteral">&quot;Delaying exit for %d seconds..\n&quot;</span>, delay);
<a name="l00874"></a>00874         sleep(delay);
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <span class="keywordflow">return</span> ret_val;
<a name="l00878"></a>00878 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Mar 31 2013 20:49:08 for applauncherd by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
